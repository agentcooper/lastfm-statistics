<html>
  <head>
    <title>Last.fm monthly playcount chart</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
      }
    </style>
    
    <script type='text/javascript' src='http://www.google.com/jsapi'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type='text/javascript'>
      function drawChart(mdata) {
        var data = new google.visualization.DataTable();
        data.addColumn('date', 'Date');
        
        mdata.data.forEach(function(pair) {
          data.addColumn('number', "[" + pair.username+ "] " + pair.artist);
          
        });
        
        var rows = [];
        Object.keys(mdata.statistics).forEach(function(date) {
          rows.push([new Date(parseInt(date))].concat(mdata.statistics[date]));
        });
        data.addRows(rows);
        
        var chart = new google.visualization.AnnotatedTimeLine(document.getElementById('chart_div'));
        chart.draw(data, {displayExactValues: true});
      }
      
      function getData() {
        var hash = window.location.hash.slice(1);
        if (!hash) return;
        
        $('#chart_div').html('Getting data...');
        $.getJSON('/monthly/', {
          'data': hash
        }, function(data) {
        
          // interpolate data
          var span = Object.keys(data.statistics).map(function(s) { return parseInt(s); }).sort(),
              min = new Date(parseInt(span[0])),
              max = new Date(parseInt(span[span.length - 1])),
              current = new Date(),
              nullArray = [];

          for (var i = 0; i < data.data.length; i++) nullArray.push(0);

          for (var y = min.getFullYear(); y <= current.getFullYear(); y++) {
            for (var m = (y == min.getFullYear()) ? min.getMonth() : 0; m < (y == current.getFullYear() ? current.getMonth() + 1 : 12); m++) {
              var hash = +new Date(y, m, 0);
              if (!data.statistics.hasOwnProperty(hash)) data.statistics[hash] = nullArray.slice(0);
            }
          }

          $('#chart_div').html('Drawing...');
          drawChart(data);
        });
      }
      
      function resizer() {
        $('#chart_div').css({
          'width': $(window).width() - 20,
        });
      }
      
      $(window).ready(resizer).bind('hashchange', getData);
      
      google.load('visualization', '1', {'packages':['annotatedtimeline']});
      google.setOnLoadCallback(getData);
    </script>
  </head>

  <body>
    <div id='chart_div' style='width: 700px; height: 400px;'>
      <p>Fire up chart building by passing hash of following structure:</p>
      <code>
        #username|artist[,username|artist]
      </code>
      <p>Example:</p>
      <code>
        #toni_neo|Depeche Mode,kotofei|Depeche Mode
      </code>
      <p>Progress will show up in the node console</p>
    </div>
  </body>
</html>